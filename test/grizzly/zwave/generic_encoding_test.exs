defmodule Grizzly.ZWave.GenericEncodingTest do
  # quokka:skip-module-reordering
  alias Grizzly.ZWave.DSK

  use ExUnit.Case,
    async: true,
    parameterize:
      [
        {:association_group_name_report, [group_id: 2, name: "some_name"],
         <<0x59, 0x02, 0x02, 0x09>> <> "some_name"},
        {:admin_code_set, [code: "1234"], <<0x63, 0x0E, 0x04, "1234">>},
        {:admin_code_report, [code: "1234"], <<0x63, 0x10, 0x04, "1234">>},
        {:admin_code_report, [code: "12345"], <<0x63, 0x10, 0x05, "12345">>},
        {:admin_pin_code_set, [code: "0123456789ABCDE"], <<0x83, 0x1A, 15, "0123456789ABCDE">>},
        {:admin_pin_code_set, [code: "01234"], <<0x83, 0x1A, 5, "01234">>},
        {:admin_pin_code_report, [result: :response_to_get, code: "0123456789ABCDE"],
         <<0x83, 0x1C, 4::4, 15::4, "0123456789ABCDE">>},
        {:admin_pin_code_report, [result: :response_to_get, code: "01234"],
         <<0x83, 0x1C, 4::4, 5::4, "01234">>},
        {:alarm_event_supported_get, [type: :access_control], <<0x71, 0x01, 0x06>>},
        {:alarm_set, [zwave_type: :home_security, status: :enabled], <<0x71, 0x06, 0x07, 0xFF>>},
        {:all_users_checksum_report, [checksum: 0x7FFF], <<0x83, 0x15, 0x7F, 0xFF>>},
        {:application_busy, [status: :try_again_after_wait, wait_time: 10],
         <<0x22, 0x01, 0x01, 0x0A>>},
        {:application_rejected_request, [], <<0x22, 0x02, 0x00>>},
        {:central_scene_configuration_set, [slow_refresh: true], <<0x5B, 0x04, 0x80>>},
        {:central_scene_configuration_set, [slow_refresh: false], <<0x5B, 0x04, 0x00>>},
        {:central_scene_configuration_report, [slow_refresh: true], <<0x5B, 0x06, 0x80>>},
        {:central_scene_configuration_report, [slow_refresh: false], <<0x5B, 0x06, 0x00>>},
        {:credential_learn_status_report,
         [
           status: :started,
           user_id: 1,
           credential_type: :password,
           credential_slot: 1,
           steps_remaining: 5
         ], <<0x83, 0x11, 0, 1::16, 2, 1::16, 5>>},
        {:association_get, [grouping_identifier: 2], <<0x85, 0x02, 0x02>>},
        {:association_groupings_report, [supported_groupings: 3], <<0x85, 0x06, 0x03>>},
        {:association_specific_group_report, [group: 5], <<0x85, 0x0C, 0x05>>},
        {:association_group_info_get, [refresh_cache: false, all: false],
         <<0x59, 0x03, 0x00, 0x00>>},
        {:association_group_info_get, [refresh_cache: true, all: false],
         <<0x59, 0x03, 0x80, 0x00>>},
        {:association_group_info_get, [refresh_cache: false, all: true],
         <<0x59, 0x03, 0x40, 0x00>>},
        {:association_group_info_get, [refresh_cache: true, all: true, group_id: 10],
         <<0x59, 0x03, 0xC0, 0x0A>>},
        {:association_group_command_list_get, [allow_cache: true, group_id: 4],
         <<0x59, 0x05, 0x80, 0x04>>},
        {:association_group_command_list_get, [allow_cache: false, group_id: 9],
         <<0x59, 0x05, 0x00, 0x09>>},
        {:barrier_operator_set, [target_value: :open], <<0x66, 0x01, 0xFF>>},
        {:barrier_operator_set, [target_value: :close], <<0x66, 0x01, 0x00>>},
        {:barrier_operator_report, [state: :open], <<0x66, 0x03, 0xFF>>},
        {:barrier_operator_report, [state: :closed], <<0x66, 0x03, 0x00>>},
        {:barrier_operator_report, [state: 50], <<0x66, 0x03, 0x32>>},
        {:barrier_operator_signal_set,
         [subsystem_type: :audible_notification, subsystem_state: :on],
         <<0x66, 0x06, 0x01, 0xFF>>},
        {:barrier_operator_signal_get, [subsystem_type: :audible_notification],
         <<0x66, 0x07, 0x01>>},
        {:barrier_operator_signal_get, [subsystem_type: :visual_notification],
         <<0x66, 0x07, 0x02>>},
        {:barrier_operator_signal_report,
         [subsystem_type: :audible_notification, subsystem_state: :on],
         <<0x66, 0x08, 0x01, 0xFF>>},
        {:configuration_bulk_get, [number_of_parameters: 3, offset: 2],
         <<0x70, 0x08, 0x02::16, 0x03>>},
        {:configuration_get, [param_number: 2], <<0x70, 0x05, 0x02>>},
        {:configuration_name_get, [param_number: 3], <<0x70, 0x0A, 0x03::16>>},
        {:configuration_name_report, [param_number: 3, reports_to_follow: 5, name: "Test Param"],
         <<0x70, 0x0B, 0x03::16, 0x05, "Test Param">>},
        {:configuration_info_get, [param_number: 4], <<0x70, 0x0C, 0x04::16>>},
        {:configuration_info_report, [param_number: 350, reports_to_follow: 0, info: "some info"],
         <<0x70, 0x0D, 350::16, 0, "some info">>},
        {:configuration_properties_get, [param_number: 5], <<0x70, 0x0E, 0x05::16>>},
        {:configuration_report, [value: -126, param_number: 15, size: 1],
         <<0x70, 0x06, 0x0F, 0x01, 0x82>>},
        {:configuration_report, [value: 115, param_number: 15, size: 1],
         <<0x70, 0x06, 0x0F, 0x01, 0x73>>},
        {:configuration_report, [value: -14313, param_number: 15, size: 2],
         <<0x70, 0x06, 0x0F, 0x02, 0xC8, 0x17>>},
        {:configuration_report, [value: 29463, param_number: 15, size: 2],
         <<0x70, 0x06, 0x0F, 0x02, 0x73, 0x17>>},
        {:configuration_report, [value: -3_664_127, param_number: 15, size: 3],
         <<0x70, 0x06, 0x0F, 0x03, 0xC8, 0x17, 0x01>>},
        {:configuration_report, [value: 7_542_529, param_number: 15, size: 3],
         <<0x70, 0x06, 0x0F, 0x03, 0x73, 0x17, 0x01>>},
        {:clock_set, [weekday: :monday, hour: 12, minute: 30],
         <<0x81, 0x04, 0x01::3, 12::5, 30>>},
        {:clock_set, [weekday: :saturday, hour: 23, minute: 59],
         <<0x81, 0x04, 0x06::3, 23::5, 59>>},
        {:clock_report, [weekday: :monday, hour: 12, minute: 30],
         <<0x81, 0x06, 0x01::3, 12::5, 30>>},
        {:credential_get, [user_id: 1, credential_type: :uwb, credential_slot: 2],
         <<0x83, 0x0B, 1::16, 0x06, 2::16>>},
        {:credential_learn_start,
         [
           user_id: 1,
           credential_type: :password,
           credential_slot: 2,
           operation_type: :modify,
           learn_timeout: 30
         ], <<0x83, 0x0F, 1::16, 0x02, 2::16, 1, 30>>},
        {:date_report, [year: 2020, month: 7, day: 16], <<0x8A, 0x04, 2020::16, 7, 16>>},
        {:door_lock_operation_set, [mode: :secured], <<0x62, 0x01, 0xFF>>},
        {:door_lock_operation_set, [mode: :unsecured], <<0x62, 0x01, 0x00>>},
        {:dsk_get, [seq_number: 1, add_mode: :learn], <<0x4D, 0x08, 0x01, 0x00>>},
        {:dsk_get, [seq_number: 1, add_mode: :add], <<0x4D, 0x08, 0x01, 0x01>>},
        {:dsk_report,
         [
           seq_number: 1,
           dsk: DSK.parse!("50285-18819-09924-30691-15973-33711-04005-03623"),
           add_mode: :learn
         ],
         <<0x4D, 0x09, 1, 0, 196, 109, 73, 131, 38, 196, 119, 227, 62, 101, 131, 175, 15, 165, 14,
           39>>},
        {:firmware_update_md_get, [number_of_reports: 2, report_number: 128],
         <<0x7A, 0x05, 2, 0x0080::16>>},
        {:humidity_control_mode_supported_report, [modes: [:off, :dehumidify]],
         <<0x6D, 0x05, 0b0000_0101>>},
        {:humidity_control_setpoint_supported_report, [setpoint_types: [:humidify, :auto]],
         <<0x64, 0x05, 0b0000_1010>>},
        {:humidity_control_setpoint_scale_supported_report, [scales: [:percentage, :absolute]],
         <<0x64, 0x07, 0b0000_0011>>},
        {:manufacturer_specific_report,
         [manufacturer_id: 1, product_type_id: 0xFFFF, product_id: 0x11],
         <<0x72, 0x05, 1::16, 0xFFFF::16, 0x11::16>>},
        {:multi_channel_aggregated_members_get, [aggregated_end_point: 1],
         <<0x60, 0x0E, 0x00::1, 0x01::7>>},
        {:multi_channel_capability_get, [end_point: 2], <<0x60, 0x09, 0x02>>},
        {:network_update_request_status, [seq_number: 2, status: :done],
         <<0x4D, 0x04, 0x02, 0x00>>},
        {:node_name_set, [encoding: :ascii, name: "motion"],
         <<0x77, 0x01, 0::5, 0::3, 109, 111, 116, 105, 111, 110>>},
        {:node_name_report, [encoding: :extended_ascii, name: "motion"],
         <<0x77, 0x03, 0::5, 1::3, 109, 111, 116, 105, 111, 110>>},
        {:node_name_set, [encoding: :ascii, name: "hall"],
         <<0x77, 0x01, 0::5, 0::3, 104, 97, 108, 108>>},
        {:node_name_report, [encoding: :utf16, name: "hall"],
         <<0x77, 0x03, 0::5, 2::3, 104, 97, 108, 108>>},
        {:node_neighbor_update_status, [seq_number: 3, status: :failed],
         <<0x34, 0x0C, 0x03, 0x23>>},
        {:node_provisioning_list_iteration_get, [seq_number: 5, remaining_counter: 255],
         <<0x78, 0x03, 5, 0xFF>>},
        {:node_provisioning_list_iteration_get, [seq_number: 5, remaining_counter: 10],
         <<0x78, 0x03, 5, 10>>},
        {:powerlevel_set, [power_level: :normal_power, timeout: 10], <<0x73, 0x01, 0x00, 0x0A>>},
        {:powerlevel_report, [power_level: :normal_power, timeout: 10],
         <<0x73, 0x03, 0x00, 0x0A>>},
        {:powerlevel_test_node_set,
         [test_node_id: 5, power_level: :minus1dBm, test_frame_count: 0xFF],
         <<0x73, 0x04, 0x05, 0x01, 0xFF::16>>},
        {:powerlevel_test_node_report,
         [test_node_id: 5, status_of_operation: :test_success, test_frame_count: 0xFF],
         <<0x73, 0x06, 0x05, 0x01, 0xFF::16>>},
        {:schedule_entry_lock_daily_repeating_get, [user_identifier: 1, schedule_slot_id: 2],
         <<0x4E, 0x0E, 1, 2>>},
        {:schedule_entry_lock_daily_repeating_report,
         [
           user_identifier: 1,
           schedule_slot_id: 2,
           week_days: [:sunday, :saturday],
           start_hour: 8,
           start_minute: 30,
           duration_hour: 2,
           duration_minute: 15
         ], <<0x4E, 0x0F, 1, 2, 0b01000001, 8, 30, 2, 15>>},
        {:schedule_entry_lock_daily_repeating_set,
         [
           set_action: :modify,
           user_identifier: 1,
           schedule_slot_id: 2,
           week_days: [:sunday, :saturday],
           start_hour: 8,
           start_minute: 30,
           duration_hour: 2,
           duration_minute: 15
         ], <<0x4E, 0x10, 1, 1, 2, 0b01000001, 8, 30, 2, 15>>},
        {:schedule_entry_lock_enable_set, [user_identifier: 100, enabled: true],
         <<0x4E, 0x01, 100, 0x01>>},
        {:schedule_entry_lock_enable_set, [user_identifier: 100, enabled: false],
         <<0x4E, 0x01, 100, 0x00>>},
        {:schedule_entry_lock_enable_all_set, [enabled: true], <<0x4E, 0x02, 0x01>>},
        {:schedule_entry_lock_enable_all_set, [enabled: false], <<0x4E, 0x02, 0x00>>},
        {:schedule_entry_lock_time_offset_report,
         [
           sign_tzo: :minus,
           hour_tzo: 4,
           minute_tzo: 20,
           sign_offset_dst: :plus,
           minute_offset_dst: 100
         ], <<0x4E, 0x0C, 1::1, 4::7, 20::8, 0::1, 100::7>>},
        {:schedule_entry_lock_time_offset_set,
         [
           sign_tzo: :minus,
           hour_tzo: 4,
           minute_tzo: 20,
           sign_offset_dst: :plus,
           minute_offset_dst: 100
         ], <<0x4E, 0x0D, 1::1, 4::7, 20::8, 0::1, 100::7>>},
        {:schedule_entry_lock_week_day_get, [user_identifier: 10, schedule_slot_id: 5],
         <<0x4E, 0x04, 10, 5>>},
        {:schedule_entry_lock_week_day_report,
         [
           user_identifier: 10,
           schedule_slot_id: 5,
           day_of_week: 3,
           start_hour: 9,
           start_minute: 30,
           stop_hour: 17,
           stop_minute: 45
         ], <<0x4E, 0x05, 10, 5, 3, 9, 30, 17, 45>>},
        {:schedule_entry_lock_week_day_set,
         [
           set_action: :modify,
           user_identifier: 10,
           schedule_slot_id: 5,
           day_of_week: 3,
           start_hour: 9,
           start_minute: 30,
           stop_hour: 17,
           stop_minute: 45
         ], <<0x4E, 0x03, 0x01, 10, 5, 3, 9, 30, 17, 45>>},
        {:schedule_entry_lock_year_day_get, [user_identifier: 10, schedule_slot_id: 5],
         <<0x4E, 0x07, 10, 5>>},
        {:schedule_entry_lock_year_day_report,
         [
           user_identifier: 20,
           schedule_slot_id: 5,
           start_year: 97,
           start_month: 10,
           start_day: 7,
           start_hour: 2,
           start_minute: 42,
           stop_year: 99,
           stop_month: 12,
           stop_day: 31,
           stop_hour: 2,
           stop_minute: 42
         ], <<0x4E, 0x08, 20, 5, 97, 10, 7, 2, 42, 99, 12, 31, 2, 42>>},
        {:schedule_entry_lock_year_day_set,
         [
           set_action: :modify,
           user_identifier: 20,
           schedule_slot_id: 5,
           start_year: 97,
           start_month: 10,
           start_day: 7,
           start_hour: 2,
           start_minute: 42,
           stop_year: 99,
           stop_month: 12,
           stop_day: 31,
           stop_hour: 2,
           stop_minute: 42
         ], <<0x4E, 0x06, 0x01, 20, 5, 97, 10, 7, 2, 42, 99, 12, 31, 2, 42>>},
        {:schedule_entry_type_supported_report,
         [
           number_of_slots_week_day: 5,
           number_of_slots_year_day: 10,
           number_of_slots_daily_repeating: 15
         ], <<0x4E, 0x0A, 5, 10, 15>>},
        {:schedule_entry_type_supported_report,
         [
           number_of_slots_week_day: 5,
           number_of_slots_year_day: 10
         ], <<0x4E, 0x0A, 5, 10>>},
        {:sensor_binary_supported_sensor_report,
         [sensor_types: [:general_purpose, :freeze, :tamper, :glass_break]],
         <<0x30, 0x04, 0b10000010, 0b00100001>>},
        {:thermostat_fan_mode_set, [mode: :auto_high], <<0x44, 0x01, 0x02>>},
        {:thermostat_fan_mode_report, [mode: :auto_high], <<0x44, 0x03, 0x02>>},
        {:thermostat_fan_mode_supported_report,
         [modes: [:auto_low, :low, :auto_high, :auto_medium]], <<0x44, 0x05, 0b00010111>>},
        {:thermostat_fan_state_report, [state: :running_high], <<0x45, 0x03, 0x02>>},
        {:thermostat_operating_state_report, [state: :cooling], <<0x42, 0x03, 0x02>>},
        {:thermostat_setback_set, [type: :temporary_override, state: -12.7],
         <<0x47, 0x01, 0::6, 1::2, 0x81>>},
        {:thermostat_setback_set, [type: :permanent_override, state: :energy_saving],
         <<0x47, 0x01, 0::6, 2::2, 0x7A>>},
        {:thermostat_setback_set, [type: :no_override, state: :frost_protection],
         <<0x47, 0x01, 0::6, 0::2, 0x79>>},
        {:thermostat_setback_report, [type: :no_override, state: :frost_protection],
         <<0x47, 0x03, 0::6, 0::2, 0x79>>},
        {:thermostat_setpoint_get, [type: :heating], <<0x43, 0x02, 0x01>>},
        {:time_offset_set,
         [
           sign_tzo: :minus,
           hour_tzo: 4,
           minute_tzo: 0,
           sign_offset_dst: :plus,
           minute_offset_dst: 60,
           month_start_dst: 3,
           day_start_dst: 23,
           hour_start_dst: 2,
           month_end_dst: 10,
           day_end_dst: 22,
           hour_end_dst: 2
         ], <<0x8A, 0x05, 0x01::1, 4::7, 0, 0x00::1, 60::7, 3, 23, 2, 10, 22, 2>>},
        {:time_offset_report,
         [
           sign_tzo: :minus,
           hour_tzo: 4,
           minute_tzo: 0,
           sign_offset_dst: :plus,
           minute_offset_dst: 60,
           month_start_dst: 3,
           day_start_dst: 23,
           hour_start_dst: 2,
           month_end_dst: 10,
           day_end_dst: 22,
           hour_end_dst: 2
         ], <<0x8A, 0x07, 0x01::1, 4::7, 0, 0x00::1, 60::7, 3, 23, 2, 10, 22, 2>>},
        {:time_parameters_set,
         [year: 2020, month: 7, day: 17, hour_utc: 14, minute_utc: 30, second_utc: 45],
         <<0x8B, 0x01, 2020::16, 7, 17, 14, 30, 45>>},
        {:time_parameters_report,
         [year: 2020, month: 7, day: 17, hour_utc: 14, minute_utc: 30, second_utc: 45],
         <<0x8B, 0x03, 2020::16, 7, 17, 14, 30, 45>>},
        {:time_report, [rtc_failure?: true, hour: 12, minute: 30, second: 45],
         <<0x8A, 0x02, 1::1, 0::2, 12::5, 30, 45>>},
        {:time_report, [rtc_failure?: false, hour: 12, minute: 30, second: 45],
         <<0x8A, 0x02, 12, 30, 45>>},
        {:user_code_checksum_report, [checksum: 0xEAAD], <<0x63, 0x12, 0xEA, 0xAD>>},
        {:user_code_users_number_report, [supported_users: 20], <<0x63, 0x05, 20>>},
        {:user_code_users_number_report, [supported_users: 20, extended_supported_users: 300],
         <<0x63, 0x05, 20, 300::16>>},
        {:user_credential_association_set,
         [credential_type: :password, credential_slot: 1, destination_user_id: 500],
         <<0x83, 0x12, 0x02, 1::16, 500::16>>},
        {:user_credential_association_report,
         [
           credential_type: :password,
           credential_slot: 1,
           destination_user_id: 500,
           status: :destination_user_id_nonexistent
         ], <<0x83, 0x13, 0x02, 1::16, 500::16, 5>>},
        {:wake_up_interval_set, [seconds: 1000, node_id: 1], <<0x84, 0x04, 1000::24, 1>>},
        {:wake_up_interval_report, [seconds: 2000, node_id: 1], <<0x84, 0x06, 2000::24, 1>>}
      ]
      |> Enum.map(fn {command_name, params, expected_binary} ->
        %{
          command_name: command_name,
          params: params,
          expected_binary: expected_binary
        }
      end)

  alias Grizzly.ZWave.Command
  alias Grizzly.ZWave.Commands

  test "encodes properly", %{
    command_name: command_name,
    params: params,
    expected_binary: expected_binary
  } do
    assert {:ok, command} = Commands.create(command_name, params)

    assert i(expected_binary) == i(Grizzly.ZWave.to_binary(command))
  end

  test "decodes properly", %{
    command_name: command_name,
    params: params,
    expected_binary: expected_binary
  } do
    assert {:ok, command} = Grizzly.ZWave.from_binary(expected_binary)

    assert command.name == command_name

    Enum.each(params, fn {key, value} ->
      assert Command.param!(command, key) == value
    end)
  end

  defp i(value), do: inspect(value, binaries: :as_binaries)
end
